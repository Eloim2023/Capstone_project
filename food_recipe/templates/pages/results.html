{% extends 'base.html' %}

{% block title %}Results{% endblock title %}

{% block content %}
<body class="resultBody">
    <h3 style="margin: 2% 0 2% 10%;" class="resultTitle">Search Results For: <span style="font-weight: bold">{{ search_query }}</span> </h3>
    {% if results %}
        <div class="resultCont" id="recipeContainer">
        {% for recipe in results %}
            <div class="card">
                <a class="cardA" href="{% url 'details' recipe.id %}">
                    
                <img src="{{ recipe.image_url }}" class="card-img-top cardImage" alt="{{ recipe.title }} image" style="height: 11rem;">
                </a>
                <form class="heartForm" action="POST">
                    <a class="heartA" href="{% url 'save_recipe' recipe.id %}">
                        <div class="iDiv">
                            <i class="fa fa-heart"></i>
                        </div>
                    </a>
                </form>
                <div class="card-body">
                    <h5 class="card-title">{{ recipe.title }}</h5>
                </div>
            
            </div>
        {% endfor %}
    </div>
    <div class="loadMoreButton">
        <button id="loadMoreBtn" class="btn btn-primary">Load More</button>
    </div>
    {% else %}
        <h3>No Results Found.</h3>
    {% endif %}
</body>

<script>
    
    document.addEventListener('DOMContentLoaded', function () {
        const loadMoreButton = document.getElementById('loadMoreBtn');
        const recipeContainer = document.getElementById('recipeContainer');
        
        let nextUrl = "{{ next_page|safe }}";
        const csrfToken = "{{ csrf_token }}";

        loadMoreButton.addEventListener('click', async function () {
            let recipeInfoArray;
            /*STOP HERE*/
            if (nextUrl) {
                fetch(nextUrl)
                    .then(response => response.json())
                    .then(async data => {
                        console.log(data);
                        nextUrl = data._links.next ? data._links.next.href : null;
                        recipeInfoArray = data.hits;
                        if (Array.isArray(recipeInfoArray) && recipeInfoArray.length > 0) {

                            const saveRecipeUrl = '/saveRecipes/save_next/';
                            const saveResponse = await fetch(saveRecipeUrl, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': csrfToken,
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(recipeInfoArray),
                            }).then(response => response.json()).then(data => 
                                data.forEach(recipeInfo => {
                                
                                const recipeCard = `
                                    <div class="card">
                                        <a class="cardA" href="/results/${recipeInfo.id}/">
                                            <img src="${recipeInfo.image_url}" class="card-img-top cardImage" alt="${recipeInfo.title} image" style="height: 11rem;">
                                        </a>
                                        <form class="heartForm" action="POST">
                                            <a class="heartA" href="/save_recipe/${recipeInfo.id}/">
                                                <div class="iDiv">
                                                    <i class="fa fa-heart"></i>
                                                </div>
                                            </a>
                                        </form>
                                        <div class="card-body">
                                            <h5 class="card-title">${recipeInfo.title}</h5>
                                        </div>
                                    </div>`;
                                
                                recipeContainer.insertAdjacentHTML('beforeend', recipeCard);
                            })
                            );

                            
                        } else {
                            console.log('No recipes found in the response.'); 
                        }
                    })
                    .catch(error => {
                        console.error('Error loading more recipes:', error);
                    });
            } else {
                loadMoreButton.disabled = true;
            }
        });
    });
</script>


{% endblock content %}
